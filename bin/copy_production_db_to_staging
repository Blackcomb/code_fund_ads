#!/bin/sh

# Requirements
# - aws-cli (brew install awscli)
# - AWS environment variables
#   * AWS_ACCESS_KEY_ID
#   * AWS_SECRET_ACCESS_KEY
#   * AWS_DEFAULT_REGION
# - Metabase environment variables
#   * METABASE_URL

app='code-fund-ads-staging'

if [ -z "$(which aws)" ]; then
  echo 'aws-cli not installed! Aborting.';
  exit 1
fi

source .env
./bin/heroku_pg_dump_production_replica
heroku pg:reset DATABASE_URL -a $app
aws s3 rm s3://codefund-backups/production-db/production-shallow.dump
aws s3 cp ./tmp/production-shallow.dump s3://codefund-backups/production-db/
url=$(aws s3 presign s3://codefund-backups/production-db/production-shallow.dump)
heroku pg:backups:restore $url DATABASE_URL -a $app
aws s3 rm s3://codefund-backups/production-db/production-shallow.dump
heroku run rails db:migrate -a $app
